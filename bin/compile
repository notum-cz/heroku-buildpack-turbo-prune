#!/usr/bin/env bash
set -euo pipefail

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

# Load Heroku config vars (files) into env
if [[ -d "$ENV_DIR" ]]; then
  for e in "$ENV_DIR"/*; do
    [[ -f "$e" ]] || continue
    export "$(basename "$e")"="$(cat "$e")"
  done
fi

TURBO_SCOPE="${TURBO_SCOPE:-}"
if [[ -z "$TURBO_SCOPE" ]]; then
  echo "Missing TURBO_SCOPE (e.g. @repo/ui). Aborting." >&2
  exit 1
fi

cd "$BUILD_DIR"

TURBO_VERSION="${TURBO_VERSION:-2.7.3}"

TMP="$(mktemp -d)"
trap 'rm -rf "$TMP"' EXIT

download_turbo() {
  local url pkgdir turbo_bin
  url="https://registry.npmjs.org/turbo-linux-64/-/turbo-linux-64-${TURBO_VERSION}.tgz"

  echo "Downloading turbo from: $url..." >&2
  curl -fsSL "$url" -o "$TMP/turbo.tgz"
  
  root_dir="$(tar -tzf "$TMP/turbo.tgz" | head -n 1 | cut -d/ -f1)"
  tar -xzf "$TMP/turbo.tgz" -C "$TMP"

  pkgdir="$TMP/$root_dir"

  turbo_bin=""
  for candidate in \
    "$pkgdir/bin/turbo" \
    "$pkgdir/bin/turbo-linux-64" \
    "$pkgdir/turbo" \
    "$pkgdir/turbo-linux-64"
  do
    if [[ -f "$candidate" ]]; then
      turbo_bin="$candidate"
      break
    fi
  done

  if [[ -z "$turbo_bin" ]]; then
    turbo_bin="$(find "$pkgdir" -maxdepth 3 -type f \( -name turbo -o -name 'turbo-linux-*' -o -name 'turbo-*' \) | head -n 1 || true)"
  fi

  if [[ -z "$turbo_bin" ]]; then
    echo "Could not find turbo binary after extracting: $url" >&2
    exit 1
  fi

  chmod +x "$turbo_bin"
  echo "$turbo_bin"
}

# Always materialize strapi-types/generated if inputs exist
if [[ -d "packages/strapi-types" ]] && compgen -G "apps/strapi/types/generated/*.d.ts" >/dev/null; then
  rm -rf "packages/strapi-types/generated"
  mkdir -p "packages/strapi-types/generated"
  cp -f apps/strapi/types/generated/*.d.ts "packages/strapi-types/generated/"
fi

TURBO_BIN="$(download_turbo)"

rm -rf out
"$TURBO_BIN" prune "$TURBO_SCOPE" --docker

# Move the `out/` directory aside before wiping repo
mv out "$TMP/out"

# Replace build dir with pruned tree
rm -rf ./* ./.??* ./.?* 2>/dev/null || true
tar -C "$TMP/out/full" -cf - . | tar -C "$BUILD_DIR" -xf -
cp -f "$TMP/out/yarn.lock" "$BUILD_DIR/yarn.lock"

echo "turbo-prune: scope=$TURBO_SCOPE turbo=$TURBO_VERSION"